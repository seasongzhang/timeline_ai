# 增加领域知识预处理层 (Domain Knowledge Preprocessing Layer)

为了让 AI 像专家一样思考，我们将建立一个**预处理层**。这个层会在数据发送给 AI 之前，模仿你（专家）的“看数据习惯”，对原始数据进行清洗、提取和标注。

## 1. 核心策略：降噪与特征提取

我们将实现以下四个维度的预处理逻辑：

### A. 智能降噪 (Noise Reduction)
**目标**：过滤掉你认为“没价值”或“多余”的信息，减少 AI 的干扰。
*   **规则**：
    *   直接忽略包含 `391管理综合故障`、`DR0`、`TC8000门机警告` 等关键词的事件。
    *   **级联故障屏蔽**：如果出现 `434 安全回路断开`，且在短时间（如 100ms）内紧接着出现 `378 软件安全回路断开`，则自动标记 `378` 为冗余信息并隐藏，只保留根因。

### B. 关键信号提取 (Golden Signal Extraction)
**目标**：从复杂的 JSON/Note 字段中，只“抠”出你关注的那几个关键参数。
*   **规则**：
    *   **D240 故障**：仅提取 `SN_5`, `SN_BK1`, `SN_BK2`, `SN_LB`, `SN_RL`, `SP_60F`, `ST_41DGL`, `ST_DZF` 的状态。
    *   **故障恢复**：仅提取 `控制同步层`。

### C. 语义翻译 (Semantic Translation)
**目标**：将“代码”翻译成“人话/业务语言”。
*   **规则**：
    *   **楼层转换**：识别 `控制同步层: 3`，自动翻译并标注为 `【电梯位于 4 楼】`（层数+1）。
    *   **人工操作识别**：
        *   除了紫色背景，增加对 `检修`、`安全回路`、`机修工单` 等关键词的检测。
        *   自动打上 `【⚠️ 现场有人工操作】` 或 `【🚨 严重故障-需派单】` 标签。

### D. 提示词工程 (Prompt Engineering)
**目标**：教 AI 你的分析逻辑。
*   **规则**：
    *   在 System Prompt 中明确优先级：`工单 > 故障发生 > 运行模式变更`。
    *   告诉 AI：`【现场有人工操作】` 期间产生的故障可能是人为调试导致的，需结合上下文判断。

---

## 2. 技术实现步骤

### 第一步：重构后端逻辑 (`backend/main.py`)
1.  **新建 `TimelinePreprocessor` 类**：封装所有的清洗和提取逻辑，保持代码整洁。
2.  **实现 `extract_critical_signals(text)` 方法**：使用正则精准提取关键 Key-Value。
3.  **实现 `apply_expert_rules(rows)` 方法**：
    *   遍历行数据，执行过滤、去重（Look-back check）和打标签。
    *   生成一份**精简版**的文本摘要 (`enriched_context`) 供 AI 阅读。

### 第二步：优化 AI 接口 (`/api/analyze`)
*   不再直接发送原始 JSON，而是发送经过 `TimelinePreprocessor` 处理后的**结构化摘要**。
*   摘要格式示例：
    ```text
    [10:58:43] [🚨严重故障] 故障代码D240 (434 安全回路断开)
    >> 关键信号: SN_RL=true, SP_60F=true
    >> 分析提示: 此故障导致了后续的 378 报错(已隐藏)

    [11:05:00] [⚠️现场人工操作] 运行模式变更 (检修)
    ```

### 第三步：验证与测试
*   使用你提供的案例（2025-12-08 的 D240 故障）进行测试，确认：
    *   378 故障是否被正确降权/隐藏。
    *   楼层是否正确显示为 4 楼。
    *   AI 是否能得出“因安全回路断开导致...”的结论。
